name: Governance CI Gate

on:
    push:
        branches: ["main","master"]
    pull_request:
        branches: ["main","master"]

jobs:
  governance:
    name: Tests + MCP-adapter linter
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install test deps
        run: |
          python -m pip install --upgrade pip
          pip install pytest pre-commit

      - name: MCP-adapter checker (forbidden direct network usage)
        run: |
          echo "Running MCP-adapter checker..."
          python tools/check_mcp_adapters.py

      - name: Verify pre-commit hooks
        run: |
          echo "Verifying pre-commit hooks are configured and pass..."
          # Ensure pre-commit is installed and run all hooks against current tree
          pre-commit run --all-files --show-diff-on-failure || (echo "pre-commit hooks failed" && exit 1)

      - name: Run tests
        run: |
          pytest -q

  verify-pr-metadata:
    name: Verify PR metadata
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check PR body for spec reference
        uses: actions/github-script@v6
        with:
          script: |
            const body = context.payload.pull_request && context.payload.pull_request.body || '';
            const re = /specs\/[a-zA-Z0-9._-]+\.md/;
            if (!re.test(body)) {
              core.setFailed('ERROR: PR violates the Prime Directive. All changes must reference a ratified specification in the specs/ folder.');
            }

